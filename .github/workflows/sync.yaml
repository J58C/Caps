name: Sync
on:
  push:
    branches:
      - '42'
      - '17048'
      - '340'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [42, 17048, 340]

    steps:
      - name: Checkout source branch (${{ matrix.branch }})
        uses: actions/checkout@v3
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Checkout main branch separately
        uses: actions/checkout@v3
        with:
          ref: main
          path: main_branch
          fetch-depth: 0

      - name: Copy files from ${{ matrix.branch }} to main/${{ matrix.branch }}
        run: |
          mkdir -p main_branch/${{ matrix.branch }}

          git checkout ${{ matrix.branch }} -- \
            Caps32Project.kicad_pcb \
            Caps32Project.kicad_plr \
            Caps32Project.kicad_pro \
            Caps32Project.kicad_sch \
            fp-info-cache || echo "Warning: Some files might not exist in branch ${{ matrix.branch }}"

          mv Caps32Project.kicad_pcb Caps32Project.kicad_plr \
             Caps32Project.kicad_pro Caps32Project.kicad_sch \
             fp-info-cache \
             main_branch/${{ matrix.branch }}/ || echo "Warning: Some files might not exist, skipping move."

      - name: Commit changes to main
        run: |
          cd main_branch
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add .
          git diff --staged --quiet || git commit -m "Sync from ${{ matrix.branch }} to main/${{ matrix.branch }}"
          git push origin main
